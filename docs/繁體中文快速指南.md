# GraphRAG 與 Gemini 整合快速指南（繁體中文）

## 專案總覽
GraphRAG 提供由文件出發的知識圖譜檢索實驗環境。`graphrag/` 目錄中的每個模組皆對應一個管線階段：`data_loader.py` 讀取原始文本、`chunker.py` 切分重疊片段、`entity_extraction.py` 推測實體與關係、`graph_builder.py` 建立 NetworkX 圖、`embedder.py` 用 TF-IDF 風格向量化、`retrieval.py` 結合向量分數與圖走訪取回內容，最後 `pipeline.py` 串接整體流程並暴露查詢介面。

## 環境與依賴
1. 建議使用虛擬環境：
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows PowerShell: .venv\Scripts\Activate.ps1
   pip install -r requirements.txt
   ```
2. 取得 Google Gemini API 金鑰，並設定環境變數：
   ```bash
   export GOOGLE_GEMINI_API_KEY="你的金鑰"  # PowerShell: setx GOOGLE_GEMINI_API_KEY "你的金鑰"
   ```
3. 為了方便本地開發，可在專案根目錄編輯 `.env` 檔案（已加入 `.gitignore`），`python-dotenv` 會自動載入其中的 `GOOGLE_GEMINI_API_KEY`。
4. 若環境無法持久化環境變數，也可在執行指令前直接使用 `--gemini-api-key` 參數傳入。

## 模組說明
- `graphrag/gemini.py`：新增的 `GeminiAnswerGenerator` 負責載入 `google-generativeai` SDK，建立提示詞並傳回模型輸出。`GeminiConfig` 提供從環境變數或參數載入設定的便利方法。
- `graphrag/pipeline.py`：`GraphRAGPipeline.query_with_gemini()` 先以既有檢索流程取得最高分片段，再交由 Gemini 生成回答，同時保留檢索脈絡，方便審核。
- `scripts/query_graph.py`：加入 `--use-gemini` 旗標與相關參數，可直接在 CLI 切換傳統摘要與 Gemini 生成結果。預設模型為 `models/gemini-1.5-flash`，程式會自動補上 `models/` 前綴，因此也可輸入 `gemini-1.5-flash-lite`、`gemini-flash-latest`、`gemma-312b-it` 等較省成本的選項。

## Gemini 整合流程
1. `GraphRAGPipeline.retrieve()` 取回最高分的 chunk 清單與圖中追蹤。
2. `GeminiAnswerGenerator.build_prompt()` 組合問題與檢索片段，要求模型輸出包含證據的 Markdown 回覆。
3. `GeminiAnswerGenerator.answer()` 呼叫 Gemini API，回傳標準化字串。
4. `query_with_gemini()` 將回答與檢索脈絡共同印出，協助除錯與評估品質。

## 圖譜建置與查詢指令

- **建立並檢視圖譜概要**
  ```bash
  python scripts/build_graph.py data
  ```
  若需匯出 GraphML 供 Gephi 或 Neo4j Bloom 觀察，可追加：
  ```bash
  python scripts/build_graph.py data --export-graphml graphrag.graphml
  ```

- **僅使用內建摘要流程提問**
  ```bash
  python scripts/query_graph.py data "GraphRAG 的基本流程是什麼？" --top-k 3
  ```

- **改由 Gemini 生成回答並指定檢索片段數**
  ```bash
  python scripts/query_graph.py data "GraphRAG 如何結合知識圖譜？" --use-gemini --top-k 3
  ```
若未預先設定環境變數，可追加：
```bash
python scripts/query_graph.py data "GraphRAG 如何結合知識圖譜？" \
  --use-gemini --gemini-api-key "你的金鑰"
```

- **輸出圖譜視覺化快照**
  ```bash
  python scripts/visualize_graph.py data --output graphrag_graph.png --layout spring
  ```
  若想聚焦在特定問題的檢索路徑，可加入：
  ```bash
  python scripts/visualize_graph.py data \
    --output graphrag_graph.png \
    --focus-question "GraphRAG 的基本流程是什麼？" \
    --top-k 5 --with-labels
  ```

## 測試與驗證
1. 先確認純內建摘要流程是否正常：
   ```bash
   python scripts/query_graph.py data "GraphRAG 的基本流程是什麼？" --top-k 3
   ```
2. 再測試 Gemini 回答（需 `.env` 或環境變數提供金鑰）：
   ```bash
   python scripts/query_graph.py data "GraphRAG 的基本流程是什麼？" --use-gemini --top-k 3
   ```
   若需指定更低成本的模型，例如 `models/gemini-flash-latest` 或 `gemma-312b-it`，可加上：
   ```bash
   python scripts/query_graph.py data "GraphRAG 的基本流程是什麼？" \
     --use-gemini --gemini-model "models/gemini-flash-latest"
```
   如果模型回傳 `Finish reason: 2` 或其他提示，表示輸出被截斷或受限，可調低 `--top-k`、增加 `--gemini-max-output-tokens`，或縮短文件內容後再重試。
3. 若你建立了單元測試，可在根目錄執行：
   ```bash
   python -m pip install pytest
   pytest
   ```
   或在未安裝 pytest 的情況下使用：
   ```bash
   python -m unittest discover tests
   ```

## 延伸實驗
- 調整 `--gemini-model`、`--gemini-temperature`、`--gemini-max-output-tokens` 觀察回答風格差異。
- 於 `graphrag/gemini.py` 變更提示詞模板，測試不同證據呈現方式。
- 建立 `tests/` 目錄，撰寫針對 Gemini 提示生成的單元測試（可用模擬物件取代 API 呼叫），確保提示維持穩定格式。
